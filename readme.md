# Информационная система учёта средства связи (ИСУСС)

Приложение реализует функцию контроля данных о средствах связи, предоставляя следующий функционал:

- Сохранение информации в базе данных;
- Фильтрация и поиск средств связи, категорий, движений и сопутствующих данных по критериям;
- Управление движениями средств связи между подразделениями и владельцами;
- Управление категорированием средств связи с контролем их порядка;
- Разделение полномочий администраторского и пользовательского доступа;
- Резервирование данных;
- Импортирование данных из внешнего источника;
- Функционалом подсчёта сроков переработки;
- Логгирование и просмотр системного журнала приложения;
- Управление целостностью данных путём подтверждения операций администратором;

## Системные требования

### Операционная система

`Linux`, `Windows 7` и выше.

### Установленное ПО

`NodeJS` версии `12.13.0` и выше.
База данных `MySQL`. Для резервного копирования исполняемые файлы `mysql`и `mysqldump` должны быть заданы в переменной среды `PATH`.

## Установка

Релизную версию приложения можно скачать по ссылке: **TODO**, либо собрать самостоятельно. Подрбности в разделе [cборки](#cборка).

### Установка на IIS

При корректной настройке приложение может работать на `IIS` веб-сервере. Для этого на `ISS` должны быть установлены следующие плагины:

- UrlRewrite
- IISNode

Необходим созданный сайт в корневой категории которого настраивается конфигурационный файл следующим образом: **TODO**

### Настройка конфиругации

Перед запуском приложения необходимо настроить его конфигурацию. В ней прописываются параметры подключения к базе данных и приватный ключ приложения.

**ВАЖНО** Секретный ключ -- особая строка, на основе которой шифруется приложение. Среди данных, подлежащих шифровке -- пароль и резервная копия. Если запустить приложение с другим секретным ключом, все данные аутентификации будут некорректны и использование без пересинхронизации базы данных будет невозможно. Таким же образом это касается резервных копий.

Конфигурация задаётся в файле `.production.env` в формате `.env` находящегося в корневой директории следующим образом:

```env
# Порт приложения (данный параметр следует убрать при запуске на IIS)
PORT=5000
# Хост (IP-адрес) базы данных
DB_HOST=localhost
# Порт подключения базы данных (по умолчанию у mysql 3306)
DB_PORT=3306
# Имя пользователя базы данных
DB_USERNAME=root
# Пароль пользователя базы данных
DB_PASSWORD=*******
# Имя базы данных
DB_NAME=senoph
# Резервный пароль администраторского аккаунта
DEFAULT_PASSWORD=*******
# Секретный ключ приложения
SECRET=**************
```

### Запуск

Убедитесь, что корректно настроили конфигурацию приложения.

**ВАЖНО**
При первом чистом запуске приложения (используя новую базу данных) необходимо произвести синхронизацию и настроить базу данных. Во время данной операции производится удаление всего содержимого базы данных и пересоздание её с корректной структурой. Это поведение по умолчанию не включено ввиду её деструктивности, но это обязательное условие для корректной работы приложения при первом чистом запуске. Если же приложение запускается при заведомо синхронизированной базе данных, данную операцию проводить не нужно.

<details>
  <summary>Запуск приложения из терминала</summary>
  
  В среде `Windows` достаточно запустить `cmd.exe` или `powershell.exe`, перейдя в корневую директорию приложения. Либо, находясь в корневой директории приложения в проводнике, зажать клавишу `SHIFT` и выбрать *Открыть окно команд*.


  Для запуска в терминале прописывается команда:
  - В случае `Windows`: start.bat \[флаги, например `--sync`\]
  - В случае `Linux`: bash ./start.sh \[флаги, например `--sync`\]

</details>

Для этой операции необходимо один раз запустить приложение (из терминала) с флагом `--sync` и дождаться сообщения об успешном запуске сервера. Если операция завершится успешно, в корневой директории создастся файл `sync.json` с данными о синхронизации. При повторном запуске приложения с флагом `--sync` и наличии `sync.json` синхронизация не произведётся и выведется сообщение об ошибке. Это необходимо для предотвращения случайного очищения базы данных, если синхронизация уже производилась. В таком случае всё ещё возможно произвести пересинхронизацию (например, при повереждении структуры базы данных или обновлении версии приложения), запустив приложение с флагом `--sync --force`, пересоздав базу данных.

Дальнейший штатный запуск приложения возможен с помощью файла командного пакета `start.bat` и скрипта `start.sh` на `Windows` и `Linux` соответственно. Либо ручной запуск из корневой директории командой `node ./build/index.js`.

### Подключение

Если журнал веб-сервера вывел сообщение об успешном запуске, в приложение можно зайти по локальному IP-адресу и указанному в конфигурации порту (в случае запуска на `IIS` -- на порту указанном в `IIS`). Пользователю представится окно входа в аккаунт, где необходимо ввести учётные данные.

![Страница входа в аккаунт](/readme/login_act.png)

**ВАЖНО** При первом запуске приложения создаётся резервный администраторский аккаунт, на котором обязательно нужно сменить пароль. Учётные данные для него: имя пользователя -- *admin*, пароль указан в конфигурационном файле по параметру `DEFAULT_PASSWORD`. Смена пароля производится на странице `/admin/users`.


## Использование



### Логгирование

Системный журнал приложения хранится в корневой директории по пути `./logs/`. Журналы записываются в три лог-файла:

- `combined.log`: Общие логи приложения, выводящиеся в консоль с доп. информацией (payload)
- `db.log`: Логи `SQL`-запросов к базе данных
- `error.log`: Схож с `combined.log`, но хранит только ошибки.

Также логи можно просмотреть в клиентском интерфейсе с учётной записи администратора, перейдя в пункт администрирование/история(логи), либо перейдя по URL `/admin/logs`. В данном разделе также хранится история действий пользователей системы

**ВАЖНО** История действий привязывается к резервной копии, при её изменении также загружается актуальная для резервной копии история.

# Техническая сторона

## Описание приложения

Это SPA-приложение, использующее `NodeJS` в качестве бека и `ReactJS` на фронте. Связь производится посредством HTTP REST-API по адресу `/api/**/*`. Бекенд использует ORM `Sequelize` для взаимодействия с базой данных. Фронт использует собственную библиотеку визуальных компонентов, а также `React Feather` для иконок. В качестве системы управления состоянием используется `@reduxjs/toolkit`, бóльшая взаимодействия с `API` осуществляется с помощью хуков `ReactJS`.

## Используемый стек технологий

### Бекенд

- Языки: `TypeScript`, `NodeJS`, `SQL`
- Модули: `Express`, `Sequelize`

### Фронтенд

- Языки: `TypeScript`, `Stylus`
- Модули: `ReactJS`, `Webpack`, `@reduxjs/toolkit`, `ReactRouter`

## Сборка

Для контроля зависимостями используется пакетный менеджер `Yarn`. Сборка производится с помощью `bash` скрипта (желательно на `Linux`), запускаемого командой `yarn deploy` из корневой директории исходного кода. Также существует вариант сборки портативной версии билда командой `yarn deploy:zip`, собирающей `.zip` архив со всем необходимым для работы приложения.

## HTTP API

С помощью `TypeScript` реализована типизация HTTP запросов к `API`. Все варианты запросов описаны в файле `/src/route/types.d.ts`, их конкретное описание приведено ниже:

### Оповещения

`GET` `/notice` -- возвращает данные о количестве неподтверждённых действий

```ts
// Ответ
phone: {
  changes: number;
  commits: number;
}
holding: {
  commits: number;
  changes: number;
}
category: {
  commits: number;
  changes: number;
}
```

### Администрирование

`GET` `/admin/backups` -- возвращает данные о резервных копиях, доступных на сервере.

```ts
// Ответ
{
  id: string;
  tag: string;
  date: string;
  size: number;
}
```

`GET` `/admin/backup/export` -- возвращает файл, `Blob` с резервной копией.

```ts
// Запрос
{
  id: string;
}
```
