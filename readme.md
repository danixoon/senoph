# Информационная система учёта средства связи (ИСУСС)

Приложение реализует функцию контроля данных о средствах связи, предоставляя следующий функционал:

- Сохранение информации в базе данных;
- Фильтрация и поиск средств связи, категорий, движений и сопутствующих данных по критериям;
- Управление движениями средств связи между подразделениями и владельцами;
- Управление категорированием средств связи с контролем их порядка;
- Разделение полномочий администраторского и пользовательского доступа;
- Резервирование данных;
- Импортирование данных из внешнего источника;
- Функционалом подсчёта сроков переработки;
- Логгирование и просмотр системного журнала приложения;
- Управление целостностью данных путём подтверждения операций администратором;

## Системные требования

### Операционная система

`Linux`, `Windows 7` и выше.

### Установленное ПО

`NodeJS` версии `12.13.0` и выше.
База данных `MySQL`. Для резервного копирования исполняемые файлы `mysql`и `mysqldump` должны быть заданы в переменной среды `PATH`.

## Установка

Релизную версию приложения можно скачать по ссылке: **TODO**, либо собрать самостоятельно. Подрбности в разделе [cборки](#cборка).

### Установка на IIS

При корректной настройке приложение может работать на `IIS` веб-сервере. Для этого на `ISS` должны быть установлены следующие плагины:

- `UrlRewrite`
- `IISNode`

Необходим созданный сайт в корневой категории которого настраивается конфигурационный файл следующим образом: **TODO**

### Настройка конфиругации

Перед запуском приложения необходимо настроить его конфигурацию. В ней прописываются параметры подключения к базе данных и приватный ключ приложения.

**ВАЖНО** Секретный ключ -- особая строка, на основе которой шифруется приложение. Среди данных, подлежащих шифровке -- пароль и резервная копия. Если запустить приложение с другим секретным ключом, все данные аутентификации будут некорректны и использование без пересинхронизации базы данных будет невозможно. Таким же образом это касается резервных копий.

Конфигурация задаётся в файле `.production.env` в формате `.env` находящегося в корневой директории следующим образом:

```env
# Порт приложения (данный параметр следует убрать при запуске на IIS)
PORT=5000
# Хост (IP-адрес) базы данных
DB_HOST=localhost
# Порт подключения базы данных (по умолчанию у mysql 3306)
DB_PORT=3306
# Имя пользователя базы данных
DB_USERNAME=root
# Пароль пользователя базы данных
DB_PASSWORD=*******
# Имя базы данных
DB_NAME=senoph
# Резервный пароль администраторского аккаунта
DEFAULT_PASSWORD=*******
# Секретный ключ приложения
SECRET=*******
```

### Запуск

Убедитесь, что корректно настроили конфигурацию приложения.

**ВАЖНО**
При первом чистом запуске приложения (используя новую базу данных) необходимо произвести синхронизацию и настроить базу данных. Во время данной операции производится удаление всего содержимого базы данных и пересоздание её с корректной структурой. Это поведение по умолчанию не включено ввиду её деструктивности, но это обязательное условие для корректной работы приложения при первом чистом запуске. Если же приложение запускается при заведомо синхронизированной базе данных, данную операцию проводить не нужно.

_Запуск приложения из терминала_

> В среде `Windows` достаточно запустить `cmd.exe` или `powershell.exe`, перейдя в корневую директорию приложения. Либо, находясь в корневой директории приложения в проводнике, зажать клавишу `SHIFT` и выбрать _Открыть окно команд_.
>
> Для запуска прописывается команда:
>
> - В случае `Windows`: start.bat \[флаги, например `--sync`\]
> - В случае `Linux`: bash ./start.sh \[флаги, например `--sync`\]

Для этой операции необходимо один раз запустить приложение (из терминала) с флагом `--sync` и дождаться сообщения об успешном запуске сервера. Если операция завершится успешно, в корневой директории создастся файл `sync.json` с данными о синхронизации.

![Процесс синхронизации базы данных](/readme/server_log_sync-ok.png)

При повторном запуске приложения с флагом `--sync` и наличии `sync.json` синхронизация не произведётся и выведется сообщение об ошибке.

![Повторная синхронизации базы данных](/readme/server_log_sync-error.png)

Это необходимо для предотвращения случайного очищения базы данных, если синхронизация уже производилась. В таком случае всё ещё возможно произвести пересинхронизацию (например, при повереждении структуры базы данных или обновлении версии приложения), запустив приложение с флагами `--sync --force`, пересоздав базу данных.

Дальнейший штатный запуск приложения возможен с помощью файла командного пакета `start.bat` и скрипта `start.sh` на `Windows` и `Linux` соответственно. Либо ручной запуск из корневой директории командой `node ./build/index.js`.

## Использование

Если журнал веб-сервера вывел сообщение об успешном запуске, в приложение можно зайти по локальному IP-адресу и указанному в конфигурации порту (в случае запуска на `IIS` -- на порту указанном в `IIS`). Пользователю представится окно входа в аккаунт, где необходимо ввести учётные данные.

![Страница входа в аккаунт](/readme/client_login_page.png)

**ВАЖНО** При первом запуске приложения создаётся резервный администраторский аккаунт, на котором обязательно нужно сменить пароль. Учётные данные для него: имя пользователя -- _admin_, пароль указан в конфигурационном файле по параметру `DEFAULT_PASSWORD`. Смена пароля производится на странице `/admin/users`.

В зависимости от роли пользователя, список доступных функций различен. Пользовательский аккаунт не имеет доступа к администраторской панели и не может подтверждать изменения в системе.

![Начальная страница](/readme/client_index_page.png)

### Навигация

Левая панель используется для навигации по системе. Функционал сгруппирован по группам, при нажатии на которые возможно раскрытие подробных пунктов.

![Панель навигации](/readme/client_side-bar.png)

### Администрирование

Данный раздел позволяет проводить управлять пользователями, владельцами, местоположениями, подразделениями, типами средств связи, моделями средств связи, резервным копированием и производить просмотр журнала системы.

Раздел доступен только пользователем с правами администратора.

Структура большинства страниц данного раздела состоит из формы добавления элемента и списком существующих в формате таблицы. Например, страница моделей средств связи выглядит следующим образом:

![Модели средств связи](/readme/client_models_page.png)

Обязательные поля форм указываются красной звёздочкой после их заголовка и без их заполнения запрос не будет выполнен. В данном случае, поля _Наименование_ и _Тип СС_ являются обязательными, в отличие от поля _Описание_.

На странице моделей средств связи также доступно добавление драгоценных металлов с помощью кнопки на форме. Предусмотрена возможность добавления нескольких драгоценных металлов разных типов соответствующего количества.

![Всплывающее окно добавления драгоценных металлов](/readme/client_models_add-detail_popup.png)

Изменение элементов страниц производится через кнопку управления в левой части соответствующей записи таблицы. В зависимости от возможных действий с элементом, выводится всплывающее окно вариантов. В случае страниц моделей средств связи, доступно два варианта: _удаление_ и _изменение_.

![Всплывающее окно действий с записью](/readme/client_models_item-actions_popup.png)

Изменение производится в форме всплывающего окна. В зависимости от страницы и параметров элемента, поля соответствующие. _Применить_ и _отменить_ возможно через кнопки управления в подвале формы.

![Всплывающее окно изменения записи](/readme/client_models_item-update_popup.png)

В стандартной таблице выводится не вся информация об элементах, которой они обладают. Например на странице моделей средств связи не выводятся столбцы _дата обновления/создания_. Отображение столбцов настраивается в параметрах таблицы, изменение которых производится нажатием на кнопку в её правом верхнем углу, в шапке.

![Всплывающее окно изменения параметров таблицы](/readme/client_models_table-settings_popup.png)

**ВАЖНО**
Удаление записей в администраторском разделе производится без всякого предупреждения и подтверждения, это необходимо учитывать. Если удалить запись без потери целостности данных невозможно (имеются какие-либо связи, например, удаляется _тип средства связи_ и оно уже привязано к какой-либо _модели_) операция завершится с ошибкой.

### Резервное копирование (`/admin/backups`)

Управление резервными копиями производится в _администраторском разделе_ в пункте _Резервные копии_. Резервная копия представляет собой снимок базы данных, который при необходимости можно _восстановить_ или _удалить_. Сохраняются все таблицы базы данных, в том числе логи действий пользователей в системе (например, удаление/добавление моделей средств связи). Поэтому при восстановлении резервной копии история действий соответствует актуальной на момент снимка.

![Страница резервных копий](/readme/client_backup_page.png)

**Создание резервной копии**

При создании необходимо указать _метку_, представляющую собой некоторую строку, идентифицирующую резервную копию. Метки могут повторяться, это не уникальное значение. Нажав на кнопку _Создать_ и корректно настроенными переменными окружения веб-сервера (раздел [системных требований](#Системные-требования)) для базы данных. Резервная копия добавится в конец списка, ей назначается указанная _метка_ и уникальный идентификатор _id_.

**Восстановление резервной копии**

Производится с помощью кнопки управления целевой записи, пунктом _Восстановление_. При использовании, система пересоздаст базу данных, залив актуальные данные и её структуру на момент резервной копии.

![Всплывающее окно управления записью резервной копии](/readme/client_backup_item-actions_popup.png)

**Экспортирование резервной копии**

Производится через соответствующий пункт в всплывающем окне управления целевой записи. Представляет собой файл расширения `.sbac` с данными резервной копии.

**Импортирование резервной копии**

На верхней панели страницы расположены элементы управления импортированием резервных копий. Перед импортом проверяется целостность резервной копии и достоверность её источника. В случае несовпадения хеш-сумм импорт завершится ошибкой. Это позволяет обеспечить дополнительный слой безопасности системы, а также защищает от непреднамеренной установки копии неподдерживающейся системой.

Данную проверку можно пропустить, активировав чек-бокс _Без проверки_.

![Панель импорта резервной копии](/readme/client_backup_import-bar.png)

## Дополнительно

### Логгирование

Системный журнал приложения хранится в корневой директории по пути `./logs/`. Журналы записываются в три лог-файла:

- `combined.log`: Общие логи приложения, выводящиеся в консоль с доп. информацией (payload)
- `db.log`: Логи `SQL`-запросов к базе данных
- `error.log`: Схож с `combined.log`, но хранит только ошибки.

Также логи можно просмотреть в клиентском интерфейсе с учётной записи администратора, перейдя в пункт администрирование/история(логи), либо перейдя по URL `/admin/logs`. В данном разделе также хранится история действий пользователей системы

**ВАЖНО** История действий привязывается к резервной копии, при её изменении также загружается актуальная для резервной копии история.

# Техническая сторона

## Описание приложения

Это SPA-приложение, использующее `NodeJS` в качестве бека и `ReactJS` на фронте. Связь производится посредством HTTP REST-API по адресу `/api/**/*`. Бекенд использует ORM `Sequelize` для взаимодействия с базой данных. Фронт использует собственную библиотеку визуальных компонентов, а также `React Feather` для иконок. В качестве системы управления состоянием используется `@reduxjs/toolkit`, бóльшая взаимодействия с `API` осуществляется с помощью хуков `ReactJS`.

## Используемый стек технологий

### Бекенд

- Языки: `TypeScript`, `NodeJS`, `SQL`
- Модули: `Express`, `Sequelize`

### Фронтенд

- Языки: `TypeScript`, `Stylus`
- Модули: `ReactJS`, `Webpack`, `@reduxjs/toolkit`, `ReactRouter`

## Сборка

Для контроля зависимостями используется пакетный менеджер `Yarn`. Сборка производится с помощью `bash` скрипта (желательно на `Linux`), запускаемого командой `yarn deploy` из корневой директории исходного кода. Также существует вариант сборки портативной версии билда командой `yarn deploy:zip`, собирающей `.zip` архив со всем необходимым для работы приложения.

## HTTP API

С помощью `TypeScript` реализована типизация HTTP запросов к `API`. Все варианты запросов описаны в файле `/src/route/types.d.ts`, их конкретное описание приведено ниже:

### Оповещения

`GET` `/notice` -- возвращает данные о количестве неподтверждённых действий

```ts
// Ответ
phone: {
  changes: number;
  commits: number;
}
holding: {
  commits: number;
  changes: number;
}
category: {
  commits: number;
  changes: number;
}
```

### Администрирование

`GET` `/admin/backups` -- возвращает данные о резервных копиях, доступных на сервере.

```ts
// Ответ
{
  id: string;
  tag: string;
  date: string;
  size: number;
}
```

`GET` `/admin/backup/export` -- возвращает файл, `Blob` с резервной копией.

```ts
// Запрос
{
  id: string;
}
```
